<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Keeper - Missões</title>
    <link rel="stylesheet" href="home_static.css"> <!-- Reutilizando o CSS da home por enquanto -->
    <link rel="stylesheet" href="missoes_static.css">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Script para incluir os componentes (topbar e sidebar) -->
    <script src="./include-all-components.js"></script>
</head>
<body>
    <!-- A barra superior será carregada automaticamente pelo script include-topbar.js -->
    <div class="page-container"> <!-- Container para o conteúdo principal -->
        <div class="main-content">
            <header class="main-header">
                <h1>Quadro de Missões</h1>
            </header>

            <main class="dashboard">
                <section class="dashboard-card">
                    <h2>Desafios do Reino</h2>
                    <p>Encare desafios propostos pelos Guardiões e ganhe recompensas épicas!</p>
                    <!-- Exemplo de Missão/Desafio -->
                    <!-- Missão 1: Criar Personagem - Em Progresso -->
                    <div class="mission-item" data-progress="30" data-total="100" data-completed="false" data-details-link="create_character_static.html">
                        <h3><i class="fas fa-scroll"></i> Crie seu Primeiro Personagem</h3>
                        <p class="mission-description">Crie um personagem completo com história, atributos e habilidades para iniciar sua jornada.</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 30%;">
                                <!-- Texto movido para fora da barra para melhor visibilidade -->
                            </div>
                            <span class="progress-text">30/100</span>
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-trophy"></i> Recompensas:
                            <span class="reward-item reward-gold"><i class="fas fa-coins"></i> 100 Ouro</span>
                            <span class="reward-item reward-gem"><i class="fas fa-gem"></i> 5 Gemas</span>
                            <span class="reward-item reward-xp"><i class="fas fa-star"></i> 200 XP</span>
                        </div>
                        <div class="mission-actions">
                            <button class="btn btn-primary btn-claim-reward" style="display: none;">Resgatar Recompensa</button>
                            <button class="btn btn-secondary btn-view-details">Ver Detalhes</button>
                        </div>
                    </div>
                    
                    <!-- Missão 2: Explorar Mapa - Pronta para Recompensa -->
                    <div class="mission-item ready-to-claim" data-progress="100" data-total="100" data-completed="false" data-details-link="#">
                        <h3><i class="fas fa-map-marked-alt"></i> Explore o Mapa Inicial</h3>
                        <p class="mission-description">Visite todos os pontos de interesse no mapa inicial do Reino de Eldoria.</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar full" style="width: 100%;"></div>
                            <span class="progress-text">100/100</span>
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-trophy"></i> Recompensas:
                            <span class="reward-item reward-gold"><i class="fas fa-coins"></i> 50 Ouro</span>
                            <span class="reward-item reward-item-special"><i class="fas fa-medal"></i> Troféu Explorador</span>
                        </div>
                        <div class="mission-actions">
                            <button class="btn btn-claim-reward">Resgatar Recompensa</button>
                            <button class="btn btn-secondary btn-view-details" style="display: none;">Ver Detalhes</button>
                        </div>
                    </div>
                    
                    <!-- Missão 3: Primeira Partida - Completa -->
                    <div class="mission-item completed" data-progress="100" data-total="100" data-completed="true" data-details-link="#">
                        <h3><i class="fas fa-dice-d20"></i> Jogue sua Primeira Partida</h3>
                        <p class="mission-description">Participe de uma sessão de jogo com outros jogadores ou com o mestre.</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar full" style="width: 100%;"></div>
                            <span class="progress-text">100/100</span>
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-trophy"></i> Recompensas:
                            <span class="reward-item reward-gold"><i class="fas fa-coins"></i> 200 Ouro</span>
                            <span class="reward-item reward-gem"><i class="fas fa-gem"></i> 10 Diamantes</span>
                        </div>
                        <div class="mission-actions">
                            <button class="btn btn-secondary btn-view-details" disabled>Concluída</button>
                        </div>
                    </div>
                    
                    <!-- Missão 4: Criar História - Nova -->
                    <div class="mission-item" data-progress="0" data-total="100" data-completed="false" data-details-link="create_history_static.html">
                        <h3><i class="fas fa-book"></i> Crie sua Primeira História</h3>
                        <p class="mission-description">Escreva uma história ou lenda para enriquecer o mundo do seu personagem.</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                            <span class="progress-text">0/100</span>
                        </div>
                        <div class="mission-reward">
                            <i class="fas fa-trophy"></i> Recompensas:
                            <span class="reward-item reward-gold"><i class="fas fa-coins"></i> 150 Ouro</span>
                            <span class="reward-item reward-xp"><i class="fas fa-star"></i> 300 XP</span>
                        </div>
                        <div class="mission-actions">
                            <button class="btn btn-primary btn-claim-reward" style="display: none;">Resgatar Recompensa</button>
                            <button class="btn btn-secondary btn-view-details">Ver Detalhes</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Barra de navegação inferior para Mobile -->
        <nav class="bottom-nav">
            <a href="home_static.html" class="bottom-nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="mesas.html" class="bottom-nav-item"><i class="fas fa-table-cells"></i><span>Mesas</span></a>
            <a href="missoes.html" class="bottom-nav-item active"><i class="fas fa-tasks"></i><span>Missões</span></a>
            <a href="inventario.html" class="bottom-nav-item"><i class="fas fa-briefcase"></i><span>Inventário</span></a>
            <a href="loja.html" class="bottom-nav-item"><i class="fas fa-store"></i><span>Loja</span></a>
            <a href="creations_static.html" class="bottom-nav-item"><i class="fas fa-magic"></i><span>Criações</span></a>
        </nav>
    </div>
    <script src="scripts/supabase-client.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const missionItems = document.querySelectorAll('.mission-item');

            missionItems.forEach(item => {
                const progressBarContainer = item.querySelector('.progress-bar-container');
                const progressBar = item.querySelector('.progress-bar');
                const progressText = item.querySelector('.progress-text');
                const claimButton = item.querySelector('.btn-claim-reward');
                const detailsButton = item.querySelector('.btn-view-details');

                // Retrieve data attributes
                const progressAttr = item.dataset.progress;
                const totalAttr = item.dataset.total;
                let isCompleted = item.dataset.completed === 'true'; // Use let as it can be updated
                const detailsLink = item.dataset.detailsLink;

                let currentProgress = 0;
                let totalValue = 1; // Default to 1 to avoid division by zero if data is missing

                if (progressAttr !== undefined && totalAttr !== undefined) {
                    currentProgress = parseInt(progressAttr, 10);
                    totalValue = parseInt(totalAttr, 10);
                    if (isNaN(currentProgress)) currentProgress = 0;
                    if (isNaN(totalValue) || totalValue <= 0) totalValue = 1; // Ensure total is positive
                }

                function updateMissionState() {
                    // Update Progress Bar
                    if (progressBarContainer && progressBar && progressText) {
                        if (typeof currentProgress === 'number' && typeof totalValue === 'number' && totalValue > 0) {
                            const percentage = Math.min((currentProgress / totalValue) * 100, 100); // Cap at 100%
                            progressBar.style.width = percentage + '%';
                            progressText.textContent = `${currentProgress}/${totalValue}`;
                            if (percentage === 100) {
                                progressBar.classList.add('full');
                            } else {
                                progressBar.classList.remove('full');
                            }
                        } else {
                            // Hide progress bar if data is invalid or not applicable
                            if(progressBarContainer) progressBarContainer.style.display = 'none';
                        }
                    } else {
                         if(progressBarContainer) progressBarContainer.style.display = 'none';
                    }

                    // Update Buttons and Item State
                    if (isCompleted) {
                        item.classList.add('completed');
                        item.classList.remove('ready-to-claim'); // Remover classe de pronto para resgatar
                        if (claimButton) claimButton.style.display = 'none';
                        if (detailsButton) {
                            detailsButton.textContent = 'Concluída';
                            detailsButton.style.display = 'inline-block';
                            detailsButton.disabled = true; // Disable if completed
                        }
                    } else {
                        item.classList.remove('completed'); // Ensure not marked completed if not
                        if (typeof currentProgress === 'number' && typeof totalValue === 'number' && currentProgress >= totalValue) {
                            // Ready to claim
                            item.classList.add('ready-to-claim'); // Adicionar classe de pronto para resgatar
                            if (claimButton) claimButton.style.display = 'inline-block';
                            if (detailsButton) detailsButton.style.display = 'none'; // Hide details when claim is available
                        } else {
                            // In progress or not started
                            item.classList.remove('ready-to-claim'); // Remover classe de pronto para resgatar
                            if (claimButton) claimButton.style.display = 'none';
                            if (detailsButton) {
                                detailsButton.textContent = 'Ver Detalhes';
                                detailsButton.style.display = 'inline-block';
                                detailsButton.disabled = false;
                                if (!detailsLink) { // If no specific link, button might be less useful
                                     // For example, disable it: detailsButton.disabled = true;
                                     // Or simply do nothing, keeping it active to show a generic details modal in future
                                }
                            }
                        }
                    }
                }

                // Initial state update
                updateMissionState();

                // Event Listeners
                if (claimButton) {
                    claimButton.addEventListener('click', () => {
                        if (!isCompleted) { // Prevent multiple claims
                            // Efeito visual de recompensa
                            item.classList.add('claiming');
                            
                            // Simular um pequeno atraso para o efeito visual
                            setTimeout(() => {
                                item.classList.remove('claiming');
                                isCompleted = true;
                                item.dataset.completed = 'true'; // Update data attribute
                                updateMissionState(); // Re-render the mission item state
                                
                                // Mostrar uma notificação ou feedback
                                const rewardToast = document.createElement('div');
                                rewardToast.className = 'reward-toast';
                                rewardToast.innerHTML = `
                                    <i class="fas fa-trophy"></i>
                                    <span>Recompensa resgatada com sucesso!</span>
                                `;
                                document.body.appendChild(rewardToast);
                                
                                // Remover a notificação após alguns segundos
                                setTimeout(() => {
                                    rewardToast.classList.add('fade-out');
                                    setTimeout(() => {
                                        document.body.removeChild(rewardToast);
                                    }, 500);
                                }, 3000);
                            }, 800);
                        }
                    });
                }

                if (detailsButton) { // Check if detailsButton exists
                    detailsButton.addEventListener('click', () => {
                        if (!isCompleted && detailsLink) { // Only navigate if not completed and link exists
                            window.location.href = detailsLink;
                        }
                    });
                }
            });
        });
    </script>
    
    <!-- Todos os estilos foram movidos para missoes_static.css -->
</body>
</html>